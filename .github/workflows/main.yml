name: MLOps CI/CD Pipeline with DVC

on: [push]

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install "dvc[gdrive]" # Install DVC

      - name: Authenticate and Configure DVC
        # This step uses a GitHub Secret to securely store your Google Drive credentials
        env:
          GDRIVE_CREDENTIALS_DATA: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
        run: |
          # Create credentials file for DVC
          echo "$GDRIVE_CREDENTIALS_DATA" > credentials.json
          dvc remote modify myremote gdrive_client_id $(jq -r '.client_id' credentials.json)
          dvc remote modify myremote gdrive_client_secret $(jq -r '.client_secret' credentials.json)

      - name: Pull DVC Data and Models
        run: dvc pull -r myremote

      - name: Reproduce DVC Pipeline
        # This command re-runs any changed stages of your pipeline
        run: dvc repro

      - name: Show Metrics
        # Display the performance of the model from the metrics file
        run: cat metrics.json